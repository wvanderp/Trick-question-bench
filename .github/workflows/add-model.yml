name: Add Model

on:
  workflow_dispatch:
    inputs:
      model_id:
        description: 'OpenRouter model ID (e.g., openai/gpt-4o)'
        required: true
        type: string
      model_name:
        description: 'Human-readable model name (e.g., GPT-4o)'
        required: true
        type: string

jobs:
  add-model:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Add model to models.json
        run: |
          # Read the current models.json
          MODELS=$(cat data/models.json)
          
          # Create new model object
          NEW_MODEL=$(cat <<EOF
          {
            "id": "${{ github.event.inputs.model_id }}",
            "name": "${{ github.event.inputs.model_name }}"
          }
          EOF
          )
          
          # Check if model already exists
          if echo "$MODELS" | jq -e --arg id "${{ github.event.inputs.model_id }}" '.[] | select(.id == $id)' > /dev/null; then
            echo "Error: Model with ID '${{ github.event.inputs.model_id }}' already exists"
            exit 1
          fi
          
          # Add the new model to the array
          echo "$MODELS" | jq --argjson model "$NEW_MODEL" '. += [$model]' > data/models.json
          
          echo "✓ Added model: ${{ github.event.inputs.model_name }} (${{ github.event.inputs.model_id }})"
      
      - name: Verify JSON format
        run: |
          # Validate the JSON is well-formed
          jq empty data/models.json
          echo "✓ models.json is valid JSON"
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Add model: ${{ github.event.inputs.model_name }}"
          title: "Add model: ${{ github.event.inputs.model_name }}"
          body: |
            ## Add New Model
            
            This PR adds a new model to the benchmark:
            
            - **Model ID:** `${{ github.event.inputs.model_id }}`
            - **Model Name:** ${{ github.event.inputs.model_name }}
            
            The model has been added to `data/models.json` and will be included in future benchmark runs.
            
            ---
            *This PR was automatically created by the "Add Model" workflow.*
          branch: add-model-${{ github.run_number }}
          delete-branch: true
          labels: |
            enhancement
            automated
